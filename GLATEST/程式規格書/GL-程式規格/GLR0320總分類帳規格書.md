# GLR0320 總分類帳規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | GLR0320                              |
| 程式名稱     | 總分類帳                               |
| 檔案大小     | 7.4KB                                 |
| 行數        | ~140                                  |
| 功能簡述     | 總分類帳報表                            |
| 複雜度       | 中                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/6                              |

## 程式功能概述

GLR0320 是泛太總帳系統中的總分類帳程式，提供使用者依據選定的公司別、會計年度、會計期間、科目範圍和成本中心等條件，產生並列印總分類帳報表。此報表主要用於詳細顯示會計科目的期初餘額、本期交易明細及期末餘額，是會計師和財務人員進行科目審核的重要工具。主要功能包括：

1. 依照公司別、會計年度和會計期間查詢總分類帳資料
2. 根據會計科目範圍篩選資料
3. 根據成本中心（部門）篩選資料
4. 依據報表代碼選擇不同的報表格式和內容
5. 顯示科目期初餘額、本期增加、本期減少及期末餘額
6. 提供報表查詢和列印功能
7. 支援 Crystal Report 報表展示
8. 支援不同貨幣顯示及匯率轉換功能

## 程式結構說明

GLR0320 的結構按功能可分為以下區域：

1. **查詢條件區**：提供使用者設定報表篩選條件的表單
2. **報表控制區**：控制報表顯示和操作的功能
3. **報表顯示區**：使用 Crystal Report Viewer 顯示報表結果
4. **後端邏輯處理區**：處理資料查詢和報表參數設定

## 頁面元素

### ASP.NET 頁面宣告

```html
<%@ Page Language="C#" AutoEventWireup="true" MasterPageFile="~/GLA.master" CodeFile="GLR0320.aspx.cs" Inherits="GLR0320" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - StyleTitle 自定義控制項
   - CrystalDecisions.Web 命名空間的 Crystal Report 相關控制項
   - System.Web.Extensions 命名空間的 ASP.NET AJAX 元件

2. **查詢條件區**：
   - 公司別下拉選單 (DrpCompany)
   - 會計年度下拉選單 (DrpAcctyear)
   - 會計期間下拉選單 (DrpAcctperiod)
   - 會計科目起始範圍 (txtAcctFrom)
   - 會計科目結束範圍 (txtAcctTo)
   - 成本中心下拉選單 (DrpDepartment)
   - 報表代碼下拉選單 (DrpReportCode)
   - 僅顯示有交易科目核取方塊 (cbxOnlyTrans)
   - 查詢按鈕 (btnQuery)

3. **科目選擇控制項**：
   - 起始科目選擇按鈕 (btnSubjectFrom)
   - 結束科目選擇按鈕 (btnSubjectTo)

4. **報表顯示區**：
   - Crystal Report Viewer (CrystalReportViewer1)
   - Crystal Report Source (CryReportSource)，連結到 GLR0320.rpt 報表檔案

## 技術實現

GLR0320 採用以下技術：

1. ASP.NET Web Forms 架構
2. Crystal Reports 報表元件 (Version 13.0.2000.0)
3. ASP.NET AJAX 技術提升使用者體驗
4. SQL Server 資料庫存取技術和存儲過程
5. 客戶端 JavaScript 功能（等待畫面顯示、彈出視窗控制）
6. 參數化 SQL 查詢和存儲過程調用
7. 用戶端表單驗證

## 依賴關係

GLR0320 依賴以下檔案與元件：

1. GLR0320.aspx.cs：總分類帳後端程式碼
2. GLR0320.rpt：Crystal Reports 報表設計檔
3. GLA.master：系統主版面
4. Busy.js：等待畫面 JavaScript 函數
5. pagefunction.js：頁面通用 JavaScript 函數
6. StyleTitle.ascx：標題樣式使用者控制項
7. Subjects.ascx：科目選擇使用者控制項
8. PanPacificClass 命名空間中的類別：
   - UserInfo：使用者資訊類別
   - DBManger：資料庫管理類別
   - JsUtility：JavaScript 工具類別
9. 資料庫存儲過程：
   - dbo.sp_GLR0320：生成總分類帳資料的存儲過程

## 使用者介面

GLR0320 的使用者介面主要由以下部分組成：

1. **標題區**：顯示「總分類帳」標題
2. **查詢條件區**：
   - 公司別：選擇要查詢的公司（提供下拉選單）
   - 會計年度：選擇會計年度（提供下拉選單）
   - 會計期間：選擇會計期間（提供下拉選單，01-13）
   - 會計科目範圍：輸入起始和結束科目代號
     - 提供科目選擇按鈕開啟科目查詢視窗
   - 成本中心：選擇部門（提供下拉選單，包含「-全部-」選項）
   - 報表代碼：選擇報表格式（提供下拉選單）
   - 僅顯示有交易科目：篩選條件（核取方塊）
   - 查詢按鈕：執行查詢並生成報表
3. **報表顯示區**：Crystal Report Viewer 顯示查詢結果

## 資料處理

GLR0320 主要處理以下資料：

1. **查詢參數處理**：
   - 從下拉式選單獲取公司別、會計年度、會計期間等參數
   - 驗證輸入參數的有效性
   - 科目範圍參數格式驗證

2. **報表參數設定**：
   - 公司名稱 (CompanyName)
   - 關帳註記 (CloseRemark)
   - 會計年度 (AcctYear)
   - 開始日期 (StartDate)
   - 結束日期 (EndDate)
   - 報表名稱 (ReportName)
   - 會計期間 (AcctPeriod)
   - 部門名稱 (DeptName)
   - 科目範圍 (AcctRange)

3. **資料查詢**：
   - 執行存儲過程 dbo.sp_GLR0320 取得總分類帳資料
   - 傳遞參數包括公司別、部門、科目範圍、報表代碼、會計年度和會計期間

4. **報表資料處理**：
   - 將查詢結果綁定到 Crystal Report
   - 儲存查詢結果到 ViewState 中，以便於分頁時使用
   - 處理科目期初、期末餘額計算

## 頁面行為

頁面載入時：
1. 初始化頁面控制項
2. 載入公司別下拉式選單
3. 預設選擇公司別（值為"20"）
4. 載入對應的報表代碼、會計年度和部門資料
5. 在部門下拉選單中新增「-全部-」選項
6. 設定科目選擇按鈕相關 JavaScript 功能

公司別變更時：
1. 清除並重新載入對應的報表代碼選項
2. 清除並重新載入對應的會計年度選項
3. 清除並重新載入對應的部門選項
4. 在部門下拉選單中新增「-全部-」選項
5. 清除科目範圍輸入框內容

科目選擇按鈕點擊時：
1. 開啟科目查詢彈出視窗
2. 當科目選擇完成後，回填選擇結果到對應的輸入框

查詢按鈕點擊時：
1. 顯示等待畫面
2. 驗證查詢條件（會計年度有效性、科目範圍有效性）
3. 取得會計期間的開始和結束日期
4. 設定報表參數
5. 執行存儲過程取得總分類帳資料
6. 將結果綁定到 Crystal Report 顯示
7. 關閉等待畫面

## 異常處理

程式包含以下異常處理機制：

1. **輸入驗證**：
   - 檢查會計年度是否為有效數字範圍 (1900-2099)
   - 檢查科目範圍的有效性（起始科目必須小於等於結束科目）
   - 當輸入無效時顯示錯誤訊息並終止查詢

2. **查詢結果檢查**：
   - 當查詢結果為空時，顯示「查無相關資料」訊息

3. **使用者提醒**：
   - 使用 JsUtility.ClientMsgBoxAjax 顯示錯誤訊息
   - 使用 JsUtility.CloseWaitScreenAjax 關閉等待畫面

## 安全性考量

1. **參數化查詢**：
   - 使用 SqlCommand 參數化傳遞給存儲過程的參數，防止 SQL 注入攻擊
   - 對重要數據參數使用適當的 SqlDbType 類型

2. **輸入驗證**：
   - 對用戶輸入進行有效性檢查，防止無效數據
   - 對輸入數據進行清理（使用 Trim()）
   - 限制科目範圍的長度和格式

3. **權限控制**：
   - 透過主版面的使用者權限系統控制頁面存取
   - 檢查用戶對特定公司資料的存取權限

## 效能考量

1. **資料查詢優化**：
   - 使用存儲過程處理複雜的總分類帳資料查詢
   - 利用參數化查詢提高執行效率
   - 科目範圍篩選減少資料處理量

2. **AJAX 更新面板**：
   - 使用 UpdatePanel 實現部分頁面更新，減少頁面重新載入
   - 使用 ScriptManager 管理 AJAX 資源

3. **資料暫存**：
   - 使用 ViewState 保存查詢結果，優化報表分頁體驗
   - 適時釋放資源 (Dt.Dispose())，提高記憶體使用效率

4. **科目選擇控制**：
   - 使用彈出視窗進行科目選擇，避免頁面重載
   - 客戶端 JavaScript 函數處理選擇結果回填

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 不同公司別和會計期間的查詢結果正確性
   - 不同科目範圍的篩選結果正確性
   - 不同報表代碼的顯示結果正確性
   - 部門篩選功能正確性
   - 報表參數傳遞正確性
   - 空結果處理正確性
   - 科目選擇功能正確性

2. **介面測試**：
   - 元件布局和樣式正確性
   - 等待畫面顯示和關閉正確性
   - 科目選擇彈出視窗功能正確性
   - 錯誤訊息顯示正確性

3. **效能測試**：
   - 大量科目資料查詢響應時間
   - 報表渲染速度
   - 不同參數組合的查詢效能表現
   - 科目選擇視窗載入速度

## 待改進事項

1. 增加科目查詢的進階篩選功能（如按科目類別篩選）
2. 加入資料匯出功能，支援多種檔案格式（Excel、PDF、CSV）
3. 優化大量科目資料的查詢效能
4. 增加報表參數儲存和載入功能
5. 提供圖形化科目餘額變動趨勢分析
6. 增加多貨幣顯示切換功能
7. 改善科目選擇界面，提供更直覺的操作體驗
8. 增加報表列印設定選項
9. 提供科目主檔快速查詢連結功能

## 維護記錄

| 日期      | 版本   | 變更內容                             | 變更人員    |
|-----------|--------|-------------------------------------|------------|
| 2025/5/6  | 1.0    | 首次建立總分類帳規格書                | Claude AI | 