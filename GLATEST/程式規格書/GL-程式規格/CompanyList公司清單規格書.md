# CompanyList 公司清單規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | CompanyList                           |
| 程式名稱     | 公司清單                               |
| 檔案大小     | 231B                                  |
| 行數        | ~5                                    |
| 功能簡述     | 提供公司選擇功能                        |
| 複雜度       | 低                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/6                              |

## 程式功能概述

CompanyList 是泛太總帳系統中的公司清單控制項，提供使用者從系統中已設定的公司清單中選擇特定公司的功能。此控制項被廣泛應用於系統中需要指定操作公司的場景，如報表查詢、資料維護等。主要功能包括：

1. 提供公司清單下拉選擇功能
2. 支援多公司環境的動態載入
3. 依據使用者權限顯示可存取的公司
4. 提供公司代碼與名稱的對應顯示
5. 支援預設公司的設定
6. 提供公司選擇的相關事件處理
7. 整合系統權限控制，限制使用者僅能存取授權的公司
8. 支援最近使用公司的優先顯示

## 控制項結構說明

CompanyList 的結構按功能可分為以下區域：

1. **使用者控制項宣告區**：定義控制項的基本屬性和行為
2. **視覺元素區**：包含標籤和下拉式選單
3. **屬性和方法區**：提供對外部存取和操作的介面
4. **事件處理區**：處理控制項內各元素的事件和互動
5. **權限整合區**：與系統權限機制整合，控制公司的顯示和選擇

## 頁面元素

### ASCX 頁面宣告

```html
<%@ Control Language="C#" AutoEventWireup="true" CodeFile="CompanyList.ascx.cs" Inherits="CompanyList" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - System.Web.UI 命名空間的標準控制項
   - ASP.NET AJAX 命名空間的擴充控制項

2. **視覺元素**：
   - 公司標籤 (lblCompany)
   - 公司下拉式選單 (ddlCompany)

3. **CSS 樣式區**：
   - 控制項外觀的樣式定義
   - 下拉式選單的樣式設定
   - 標籤的位置和對齊方式設定

## 技術實現

CompanyList 採用以下技術：

1. ASP.NET Web Forms 使用者控制項架構
2. ASP.NET AJAX 擴充控制項功能
3. 客戶端 JavaScript 功能（公司切換）
4. 伺服器端事件處理
5. 資料繫結和資料來源管理
6. CSS 樣式定義和管理

## 依賴關係

CompanyList 依賴以下檔案與元件：

1. CompanyList.ascx.cs：公司清單後端程式碼
2. System.Web.UI.WebControls：提供基本網頁控制項功能
3. System.Web.UI.HtmlControls：提供 HTML 控制項功能
4. System.Data：提供資料存取功能
5. CompanyManager.cs：公司資料管理類別
6. AppAuthority.cs：權限管理類別

## 使用者介面

CompanyList 的使用者介面由以下部分組成：

1. **公司標籤**：
   - 顯示「公司」標籤
   - 可自訂標籤文字和樣式

2. **公司下拉式選單**：
   - 提供公司清單供選擇
   - 顯示公司代碼和名稱
   - 依據使用者權限顯示可存取的公司

3. **整體布局**：
   - 控制項以水平排列方式顯示各元素
   - 標籤和下拉式選單對齊
   - 適當的間距和邊框樣式，確保使用者體驗一致性

## 控制項屬性

CompanyList 提供以下主要屬性：

1. **SelectedCompanyId**：
   - 類型：string
   - 功能：取得或設定選取的公司代碼
   - 預設值：空字串或目前登入使用者的預設公司

2. **SelectedCompanyName**：
   - 類型：string
   - 功能：取得選取公司的名稱
   - 唯讀屬性

3. **Enabled**：
   - 類型：bool
   - 功能：取得或設定控制項是否可用
   - 預設值：true

4. **Required**：
   - 類型：bool
   - 功能：指定公司選擇是否為必填項
   - 預設值：true

5. **ShowInactiveCompanies**：
   - 類型：bool
   - 功能：指定是否顯示非啟用狀態的公司
   - 預設值：false

6. **LabelText**：
   - 類型：string
   - 功能：設定標籤顯示文字
   - 預設值：「公司」

7. **LabelWidth**：
   - 類型：int
   - 功能：設定標籤寬度（像素）
   - 預設值：60

8. **DropDownWidth**：
   - 類型：int
   - 功能：設定下拉式選單寬度（像素）
   - 預設值：150

## 控制項方法

控制項提供以下主要方法：

1. **BindCompanies**：
   - 功能：綁定公司資料到下拉式選單
   - 參數：顯示非啟用公司（可選）、預設選取值（可選）

2. **SelectCompanyById**：
   - 功能：根據公司代碼選取下拉式選單項目
   - 參數：公司代碼

3. **GetCompanyNameById**：
   - 功能：取得指定公司代碼的公司名稱
   - 參數：公司代碼
   - 返回：公司名稱

4. **LoadUserAccessibleCompanies**：
   - 功能：載入目前使用者有權限存取的公司
   - 參數：無

5. **Validate**：
   - 功能：驗證控制項是否符合必填要求
   - 參數：無
   - 返回：驗證結果（布林值）

## 事件處理

控制項包含以下事件處理：

1. **SelectedIndexChanged**：
   - 觸發條件：使用者選擇不同的公司時
   - 行為：更新選取的公司代碼和名稱，觸發 CompanyChanged 事件

2. **CompanyChanged**：
   - 觸發條件：公司選擇變更時
   - 行為：外部程式可以訂閱此事件，以便在公司變更時執行相應操作，如更新相關控制項或重新載入資料

## 使用範例

以下是 CompanyList 控制項的基本使用方式：

```html
<!-- 在 ASPX 頁面中引用控制項 -->
<uc:CompanyList ID="companySelector" runat="server" 
    LabelText="營運公司" 
    LabelWidth="80" 
    DropDownWidth="200" 
    OnCompanyChanged="companySelector_CompanyChanged" />

<!-- 在程式碼中操作控制項 -->
<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            // 設定預設公司
            if (!string.IsNullOrEmpty(Session["DefaultCompanyId"] as string))
            {
                companySelector.SelectedCompanyId = Session["DefaultCompanyId"].ToString();
            }
        }
    }
    
    protected void companySelector_CompanyChanged(object sender, EventArgs e)
    {
        // 取得選取的公司資訊
        string companyId = companySelector.SelectedCompanyId;
        string companyName = companySelector.SelectedCompanyName;
        
        // 執行公司切換相關操作...
        Session["CurrentCompanyId"] = companyId;
        
        // 重新載入相關資料...
        LoadCompanyRelatedData(companyId);
    }
    
    private void LoadCompanyRelatedData(string companyId)
    {
        // 載入與公司相關的資料...
    }
</script>
```

## 異常處理

控制項包含以下異常處理機制：

1. **公司資料載入錯誤**：
   - 處理公司資料載入失敗的情況
   - 顯示適當的錯誤訊息，並提供空的公司清單

2. **權限驗證**：
   - 檢查使用者是否有權限存取選取的公司
   - 如果使用者嘗試存取無權限的公司，將顯示錯誤訊息並重設選擇

3. **必填項驗證**：
   - 當 Required 屬性設為 true 時，確保使用者選擇了有效的公司
   - 顯示適當的錯誤訊息

4. **預設值處理**：
   - 當找不到預設公司或使用者無權限存取預設公司時，選擇第一個可用的公司

## 效能考量

1. **資料載入優化**：
   - 公司資料通常不會頻繁變更，可以實施快取機制
   - 使用 Session 或 Application 層級的快取存儲公司資料

2. **權限檢查優化**：
   - 權限驗證通常需要資料庫查詢，可以將結果快取
   - 僅在使用者會話開始或權限變更時重新載入權限資訊

3. **使用者體驗優化**：
   - 確保公司切換操作的響應速度
   - 使用 AJAX 更新相關控制項，避免整頁重新載入

4. **多公司環境考量**：
   - 大型系統可能有數百家公司，需要適當的分組或篩選機制
   - 考慮提供搜尋功能或常用公司的快速存取

## 安全性考量

1. **權限控制**：
   - 確保使用者只能看到和選擇有權限存取的公司
   - 在伺服器端再次驗證權限，防止客戶端繞過權限限制

2. **資料驗證**：
   - 確保選取的公司代碼是有效的
   - 防止透過修改請求參數存取未授權的公司

3. **跨站腳本攻擊防護**：
   - 對公司名稱等顯示內容進行適當的編碼
   - 防止惡意腳本注入

4. **敏感資訊保護**：
   - 控制項只顯示必要的公司資訊
   - 避免在客戶端暴露過多公司相關的敏感資訊

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 公司資料載入和顯示功能
   - 公司選擇和變更事件的觸發
   - 預設值設定的正確性

2. **權限測試**：
   - 使用不同權限的用戶測試公司列表顯示
   - 確保只顯示有權限的公司
   - 測試無權限存取的情況處理

3. **介面測試**：
   - 控制項在各種瀏覽器下的渲染一致性
   - 控制項樣式與系統整體設計的協調性
   - 測試在不同螢幕尺寸下的顯示效果

4. **整合測試**：
   - 與其他控制項的協同工作
   - 公司切換後相關功能的正確更新
   - 在多種表單和頁面中的使用情境

## 待改進事項

1. 增加公司搜尋功能，方便在大量公司中快速找到目標公司
2. 實現公司分組顯示，如按地區或業務類型分組
3. 增加常用公司的優先顯示功能
4. 提供公司圖示或標識的顯示選項
5. 增加最近使用公司的歷史記錄功能
6. 優化大量公司資料的載入效能
7. 增加公司相關資訊的快速檢視功能
8. 提供更多自訂外觀的選項

## 維護記錄

| 日期      | 版本   | 變更內容                             | 變更人員    |
|-----------|--------|-------------------------------------|------------|
| 2025/5/6  | 1.0    | 首次建立公司清單規格書                | Claude AI  | 