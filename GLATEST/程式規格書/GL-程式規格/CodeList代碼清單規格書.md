# CodeList 代碼清單規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | CodeList                              |
| 程式名稱     | 代碼清單                               |
| 檔案大小     | 189B                                  |
| 行數        | ~5                                    |
| 功能簡述     | 提供代碼選擇功能                        |
| 複雜度       | 中                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/6                              |

## 程式功能概述

CodeList 是泛太總帳系統中的代碼清單控制項，提供使用者從預設或動態載入的代碼清單中選擇特定代碼的功能。此控制項被廣泛應用於系統中需要選擇固定代碼的場景，如貨幣代碼、銀行代碼、稅務代碼等。主要功能包括：

1. 提供代碼清單下拉選擇功能
2. 支援不同代碼類型的動態載入
3. 支援代碼的搜尋和篩選功能
4. 提供代碼與描述的對應顯示
5. 支援預設代碼的設定
6. 提供代碼選擇的相關事件處理
7. 與資料庫代碼表格整合，自動更新代碼清單
8. 支援常用和最近使用的代碼優先顯示

## 控制項結構說明

CodeList 的結構按功能可分為以下區域：

1. **使用者控制項宣告區**：定義控制項的基本屬性和行為
2. **視覺元素區**：包含標籤、下拉式選單和搜尋框
3. **屬性和方法區**：提供對外部存取和操作的介面
4. **事件處理區**：處理控制項內各元素的事件和互動
5. **資料來源設定區**：定義和管理代碼資料來源

## 頁面元素

### ASCX 頁面宣告

```html
<%@ Control Language="C#" AutoEventWireup="true" CodeFile="CodeList.ascx.cs" Inherits="CodeList" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - System.Web.UI 命名空間的標準控制項
   - ASP.NET AJAX 命名空間的擴充控制項

2. **視覺元素**：
   - 代碼標籤 (lblCode)
   - 代碼下拉式選單 (ddlCode)
   - 代碼搜尋框 (txtSearch)
   - 代碼清單按鈕 (btnCodeList)

3. **CSS 樣式區**：
   - 控制項外觀的樣式定義
   - 下拉式選單的樣式設定
   - 標籤的位置和對齊方式設定

## 技術實現

CodeList 採用以下技術：

1. ASP.NET Web Forms 使用者控制項架構
2. ASP.NET AJAX 擴充控制項功能
3. 客戶端 JavaScript 功能（搜尋和篩選）
4. 伺服器端事件處理
5. 資料繫結和資料來源管理
6. CSS 樣式定義和管理

## 依賴關係

CodeList 依賴以下檔案與元件：

1. CodeList.ascx.cs：代碼清單後端程式碼
2. System.Web.UI.WebControls：提供基本網頁控制項功能
3. System.Web.UI.HtmlControls：提供 HTML 控制項功能
4. System.Data：提供資料存取功能
5. pagefunction.js：頁面通用 JavaScript 函數
6. IBosDB.cs：資料庫連接類別

## 使用者介面

CodeList 的使用者介面由以下部分組成：

1. **代碼標籤**：
   - 顯示代碼類型的描述標籤
   - 可自訂標籤文字和樣式

2. **代碼下拉式選單**：
   - 提供代碼清單供選擇
   - 顯示代碼值和描述
   - 支援搜尋和篩選

3. **搜尋框**：
   - 提供快速搜尋代碼的功能
   - 支援模糊匹配和即時篩選

4. **代碼清單按鈕**：
   - 顯示完整代碼清單的彈出視窗
   - 支援進階搜尋和選擇

5. **整體布局**：
   - 控制項以水平排列方式顯示各元素
   - 標籤和下拉式選單對齊
   - 適當的間距和邊框樣式，確保使用者體驗一致性

## 控制項屬性

CodeList 提供以下主要屬性：

1. **CodeType**：
   - 類型：string
   - 功能：設定代碼類型，如貨幣代碼、銀行代碼等
   - 預設值：空字串

2. **SelectedCode**：
   - 類型：string
   - 功能：取得或設定選取的代碼值
   - 預設值：空字串

3. **SelectedDescription**：
   - 類型：string
   - 功能：取得選取代碼的描述
   - 唯讀屬性

4. **Enabled**：
   - 類型：bool
   - 功能：取得或設定控制項是否可用
   - 預設值：true

5. **Required**：
   - 類型：bool
   - 功能：指定代碼選擇是否為必填項
   - 預設值：false

6. **SearchEnabled**：
   - 類型：bool
   - 功能：指定是否啟用搜尋功能
   - 預設值：true

7. **LabelText**：
   - 類型：string
   - 功能：設定標籤顯示文字
   - 預設值：「代碼」

8. **LabelWidth**：
   - 類型：int
   - 功能：設定標籤寬度（像素）
   - 預設值：80

9. **DropDownWidth**：
   - 類型：int
   - 功能：設定下拉式選單寬度（像素）
   - 預設值：150

## 控制項方法

控制項提供以下主要方法：

1. **BindCode**：
   - 功能：繫結代碼資料到下拉式選單
   - 參數：代碼類型、預設選取值（可選）

2. **BindCodeFromDataSource**：
   - 功能：從指定資料來源繫結代碼資料
   - 參數：資料來源、值欄位、文字欄位、預設選取值（可選）

3. **ClearSelection**：
   - 功能：清除目前選取的代碼
   - 參數：無

4. **SelectByCode**：
   - 功能：根據代碼值選取下拉式選單項目
   - 參數：代碼值

5. **SelectByIndex**：
   - 功能：根據索引選取下拉式選單項目
   - 參數：項目索引

6. **ReloadCodeList**：
   - 功能：重新載入代碼清單
   - 參數：代碼類型（可選）

7. **GetCodeDescription**：
   - 功能：取得指定代碼的描述
   - 參數：代碼值
   - 返回：代碼描述

## 事件處理

控制項包含以下事件處理：

1. **SelectedIndexChanged**：
   - 觸發條件：使用者選擇不同的代碼時
   - 行為：更新選取的代碼值，觸發 CodeChanged 事件

2. **CodeChanged**：
   - 觸發條件：代碼值變更時
   - 行為：外部程式可以訂閱此事件，以便在代碼變更時執行相應操作

3. **Search_TextChanged**：
   - 觸發條件：搜尋框文字變更時
   - 行為：根據輸入的文字篩選代碼清單

4. **CodeListButton_Click**：
   - 觸發條件：點擊代碼清單按鈕時
   - 行為：顯示完整代碼清單的彈出視窗

## 使用範例

以下是 CodeList 控制項的基本使用方式：

```html
<!-- 在 ASPX 頁面中引用控制項 -->
<uc:CodeList ID="currencyCode" runat="server" 
    CodeType="CURRENCY" 
    LabelText="貨幣代碼" 
    LabelWidth="100" 
    DropDownWidth="180" 
    OnCodeChanged="currencyCode_CodeChanged" />

<!-- 在程式碼中操作控制項 -->
<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            // 設定預設貨幣代碼
            currencyCode.SelectedCode = "TWD";
        }
    }
    
    protected void currencyCode_CodeChanged(object sender, EventArgs e)
    {
        // 取得選取的貨幣代碼
        string code = currencyCode.SelectedCode;
        string description = currencyCode.SelectedDescription;
        
        // 執行相關操作...
    }
</script>
```

## 異常處理

控制項包含以下異常處理機制：

1. **輸入驗證**：
   - 檢查代碼類型是否有效
   - 檢查選取的代碼是否存在於代碼清單中

2. **錯誤處理**：
   - 使用 try-catch 區塊處理可能發生的例外
   - 如資料庫連接錯誤、代碼載入失敗等

3. **必填項驗證**：
   - 當 Required 屬性設為 true 時，確保使用者選擇了有效的代碼
   - 顯示適當的錯誤訊息

4. **資料來源處理**：
   - 當指定的代碼類型不存在時，顯示空的代碼清單
   - 提供相應的錯誤訊息或預設行為

## 效能考量

1. **資料載入優化**：
   - 延遲載入代碼資料，直到控制項被顯示或使用
   - 快取常用代碼類型的資料，減少資料庫查詢

2. **搜尋優化**：
   - 使用客戶端搜尋功能，減少伺服器請求
   - 實現高效的字串匹配算法

3. **記憶體管理**：
   - 合理管理大型代碼清單的記憶體使用
   - 當代碼清單過大時，使用分頁或延遲載入技術

4. **資料庫查詢優化**：
   - 僅查詢必要的代碼資料欄位
   - 適當使用資料庫索引，提高查詢效率

## 安全性考量

1. **輸入驗證**：
   - 檢查所有輸入值的有效性，防止無效資料
   - 防止透過控制項的屬性傳入惡意資料

2. **資料繫結**：
   - 使用安全的資料繫結方式，避免SQL注入風險
   - 對代碼資料進行適當的編碼和過濾

3. **權限控制**：
   - 根據使用者權限顯示或限制特定代碼類型
   - 與系統的權限控制機制整合

4. **資料保護**：
   - 確保敏感代碼資訊的安全處理
   - 適當時使用加密或隱藏部分代碼信息

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 不同代碼類型的載入和顯示
   - 代碼選擇和變更事件的觸發
   - 搜尋和篩選功能的正確性

2. **界面測試**：
   - 控制項在各種瀏覽器下的渲染一致性
   - 控制項樣式與系統整體設計的協調性
   - 不同螢幕尺寸下的顯示效果

3. **整合測試**：
   - 與其他控制項的協同工作
   - 在各種表單和頁面中的使用情境

4. **效能測試**：
   - 大量代碼資料下的載入和搜尋效能
   - 多用戶同時使用時的系統負載

## 待改進事項

1. 增加多選模式，允許選擇多個代碼
2. 改進搜尋演算法，提供更智能的匹配和排序
3. 加入自動完成功能，提升使用者體驗
4. 提供代碼的階層顯示和分類功能
5. 增加代碼的視覺標記，如顏色、圖標等
6. 優化大型代碼清單的處理效能
7. 增加代碼的快捷鍵選擇功能
8. 提供更多自訂外觀的選項

## 維護記錄

| 日期      | 版本   | 變更內容                             | 變更人員    |
|-----------|--------|-------------------------------------|------------|
| 2025/5/6  | 1.0    | 首次建立代碼清單規格書                | Claude AI  | 