# GLR02R0 科目對帳單規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | GLR02R0                              |
| 程式名稱     | 科目對帳單                             |
| 檔案大小     | 5.3KB                                 |
| 行數        | ~100                                  |
| 功能簡述     | 科目對帳報表                            |
| 複雜度       | 中                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/6                              |

## 程式功能概述

GLR02R0 是泛太總帳系統中的科目對帳單程式，提供使用者依據選定的公司別、會計年度和會計期間，產生並列印科目對帳報表。此報表主要用於驗證科目餘額的正確性，列示特定期間內科目的明細交易和期末餘額，同時以報表方式呈現傳票刪除統計資訊。主要功能包括：

1. 依照公司別、會計年度和會計期間查詢科目交易資料
2. 顯示特定期間內被刪除的傳票明細
3. 列示傳票刪除日期、傳票編號及修改時間
4. 統計期間內刪除傳票的總數量
5. 提供報表查詢和列印功能
6. 支援 Crystal Report 報表展示

## 程式結構說明

GLR02R0 的結構按功能可分為以下區域：

1. **查詢條件區**：提供使用者設定報表篩選條件的表單
2. **報表控制區**：控制報表顯示和操作的功能
3. **報表顯示區**：使用 Crystal Report Viewer 顯示報表結果
4. **後端邏輯處理區**：處理資料查詢和報表參數設定

## 頁面元素

### ASP.NET 頁面宣告

```html
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="GLR02R0.aspx.cs" MasterPageFile="~/GLA.master" Inherits="GLR02R0" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - StyleTitle 自定義控制項
   - CrystalDecisions.Web 命名空間的 Crystal Report 相關控制項
   - System.Web.Extensions 命名空間的 ASP.NET AJAX 元件

2. **查詢條件區**：
   - 公司別下拉選單 (DrpCompany)
   - 會計年度下拉選單 (DrpAcctYear)
   - 會計期間起始下拉選單 (DrpFromperiod)
   - 會計期間結束下拉選單 (DrpToperiod)
   - 查詢按鈕 (btnQuery)

3. **報表顯示區**：
   - Crystal Report Viewer (CrystalReportViewer1)
   - Crystal Report Source (CryReportSource)，連結到 GLR02R0.rpt 報表檔案

## 技術實現

GLR02R0 採用以下技術：

1. ASP.NET Web Forms 架構
2. Crystal Reports 報表元件 (Version 13.0.2000.0)
3. ASP.NET AJAX 技術提升使用者體驗
4. SQL Server 資料庫存取技術
5. 客戶端 JavaScript 功能（等待畫面顯示）
6. 參數化 SQL 查詢技術

## 依賴關係

GLR02R0 依賴以下檔案與元件：

1. GLR02R0.aspx.cs：科目對帳單後端程式碼
2. GLR02R0.rpt：Crystal Reports 報表設計檔
3. GLA.master：系統主版面
4. Busy.js：等待畫面 JavaScript 函數
5. pagefunction.js：頁面通用 JavaScript 函數
6. StyleTitle.ascx：標題樣式使用者控制項
7. PanPacificClass 命名空間中的類別：
   - UserInfo：使用者資訊類別
   - DBManger：資料庫管理類別
   - JsUtility：JavaScript 工具類別

## 使用者介面

GLR02R0 的使用者介面主要由以下部分組成：

1. **標題區**：顯示「傳票刪除清單」標題
2. **查詢條件區**：
   - 公司別：選擇要查詢的公司（提供下拉選單）
   - 會計年度：選擇會計年度（提供下拉選單）
   - 會計期間：選擇起始和結束會計期間（兩個下拉選單，01-13）
   - 查詢按鈕：執行查詢並生成報表
3. **報表顯示區**：Crystal Report Viewer 顯示查詢結果

## 資料處理

GLR02R0 主要處理以下資料：

1. **查詢參數處理**：
   - 從下拉式選單獲取公司別、會計年度和會計期間
   - 驗證輸入參數的有效性

2. **報表參數設定**：
   - 公司名稱 (CompanyName)
   - 關帳註記 (CloseRemark)
   - 會計年度 (AcctYear)
   - 起始期間 (FromPeriod)
   - 結束期間 (ToPeriod)
   - 開始日期 (StartDate)
   - 結束日期 (EndDate)
   - 報表名稱 (ReportName)
   - 刪除筆數 (CountNum)

3. **資料查詢**：
   - 執行 SQL 查詢取得已刪除傳票資料（使用 dletflag='Y' 條件）
   - 使用參數化查詢防止 SQL 注入

4. **報表資料處理**：
   - 將查詢結果綁定到 Crystal Report
   - 計算刪除筆數並傳遞給報表
   - 儲存查詢結果到 ViewState 中，以便於分頁時使用

## 頁面行為

頁面載入時：
1. 初始化頁面控制項
2. 載入公司別下拉式選單
3. 預設選擇公司別（值為"20"）
4. 載入對應的會計年度

公司別變更時：
1. 清除並重新載入對應的會計年度選項

查詢按鈕點擊時：
1. 顯示等待畫面
2. 驗證查詢條件（會計年度有效性、期間先後順序）
3. 取得會計期間的開始和結束日期
4. 設定報表參數
5. 執行 SQL 查詢取得傳票刪除數據
6. 計算總刪除數量並設定為報表參數
7. 將結果綁定到 Crystal Report 顯示
8. 關閉等待畫面

## 異常處理

程式包含以下異常處理機制：

1. **輸入驗證**：
   - 檢查會計年度是否為有效數字範圍 (1900-2099)
   - 檢查起始會計期間是否小於等於結束會計期間
   - 當輸入無效時顯示錯誤訊息並終止查詢

2. **查詢結果檢查**：
   - 當查詢結果為空時，顯示「查無相關資料」訊息
   - 隱藏 Crystal Report Viewer 以避免顯示空白報表

3. **使用者提醒**：
   - 使用 JsUtility.ClientMsgBoxAjax 顯示錯誤訊息
   - 使用 JsUtility.CloseWaitScreenAjax 關閉等待畫面

## 安全性考量

1. **參數化查詢**：
   - 使用 SqlCommand 參數化查詢，防止 SQL 注入攻擊
   - 避免直接拼接使用者輸入到 SQL 查詢字串

2. **輸入驗證**：
   - 對用戶輸入進行有效性檢查，防止無效數據

3. **權限控制**：
   - 透過主版面的使用者權限系統控制頁面存取

## 效能考量

1. **資料查詢優化**：
   - 使用條件過濾 (voucherdate between @Startdate AND @Enddate)
   - 只查詢已刪除傳票 (RTRIM(dletflag)='Y')

2. **AJAX 更新面板**：
   - 使用 UpdatePanel 實現部分頁面更新，減少頁面重新載入
   - 使用 ScriptManager 管理 AJAX 資源

3. **資料暫存**：
   - 使用 ViewState 保存查詢結果，優化報表分頁體驗

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 不同公司別和會計期間的查詢結果正確性
   - 報表參數傳遞正確性
   - 空結果處理正確性
   - 期間範圍驗證正確性

2. **介面測試**：
   - 元件布局和樣式正確性
   - 等待畫面顯示和關閉正確性
   - 錯誤訊息顯示正確性

3. **效能測試**：
   - 大量資料查詢響應時間
   - 報表渲染速度

## 待改進事項

1. 增加更多篩選條件，如傳票類型或刪除者
2. 增加刪除原因說明欄位
3. 加入資料匯出功能，支援多種檔案格式
4. 優化刪除傳票的搜尋效能
5. 增加報表參數儲存和載入功能
6. 增加刪除傳票統計圖表功能

## 維護記錄

| 日期      | 版本   | 變更內容                             | 變更人員    |
|-----------|--------|-------------------------------------|------------|
| 2025/5/6  | 1.0    | 首次建立科目對帳單規格書              | Claude AI | 