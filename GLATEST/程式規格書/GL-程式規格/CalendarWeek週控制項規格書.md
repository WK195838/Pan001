# CalendarWeek 週控制項規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | CalendarWeek                           |
| 程式名稱     | 週控制項                                |
| 檔案大小     | 1.4KB                                 |
| 行數        | ~40                                   |
| 功能簡述     | 提供週選擇功能                           |
| 複雜度       | 中                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/13                             |

## 程式功能概述

CalendarWeek 是泛太總帳系統中的週選擇控制項，專門設計用於處理週期性報表、分析或業務流程中的週選擇需求。此控制項提供使用者友好的介面，允許使用者從下拉選單或直接輸入方式選擇特定年份和月份中的週數，同時具備輸入驗證和相依性管理能力。主要功能包括：

1. 提供 1-5 週範圍選擇（根據月份自動調整可選範圍，某些月份可能有第6週）
2. 支援兩種選擇方式：下拉選單和直接輸入
3. 基於所選年份和月份自動計算該月包含的週數
4. 提供必填/選填設定選項
5. 支援唯讀模式顯示
6. 整合系統樣式，提供一致的使用者體驗
7. 支援標籤文字自訂
8. 提供資料驗證功能
9. 支援與年份和月份控制項的協同工作
10. 支援事件通知，方便與其他控制項互動

此控制項通常與 CalendarYear 和 CalendarMonth 等其他日期相關控制項組合使用，共同構成完整的週期選擇功能。

## 控制項結構說明

CalendarWeek 的結構按功能可分為以下區域：

1. **使用者控制項宣告區**：定義控制項的基本屬性和行為
2. **視覺元素區**：包含年度下拉式選單、月份下拉式選單和週次下拉式選單
3. **屬性和方法區**：提供對外部存取和操作的介面
4. **事件處理區**：處理控制項內各元素的事件和互動

## 頁面元素

### ASCX 頁面宣告

```html
<%@ Control Language="C#" AutoEventWireup="true" CodeFile="CalendarWeek.ascx.cs" Inherits="CalendarWeek" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - System.Web.UI 命名空間的標準控制項
   - ASP.NET AJAX 命名空間的擴充控制項

2. **視覺元素**：
   - 年度下拉式選單 (ddlYear)
   - 月份下拉式選單 (ddlMonth)
   - 週次下拉式選單 (ddlWeek)
   - 顯示標籤和說明文字

3. **CSS 樣式區**：
   - 控制項外觀的樣式定義
   - 下拉式選單的樣式設定
   - 標籤的位置和對齊方式設定

## 技術實現

CalendarWeek 控制項基於以下技術實現：

1. **ASP.NET Web Forms**：使用 ASP.NET 使用者控制項（.ascx）技術
2. **HTML/CSS**：使用標準 HTML 元素和 CSS 樣式定義界面
3. **JavaScript**：提供客戶端的互動功能和初步驗證
4. **C# 程式碼**：在後端實現控制項的核心邏輯（詳見 CalendarWeek.ascx.cs）
5. **AJAX**：支援無刷新更新控制項狀態
6. **日期計算**：包含複雜的週數計算邏輯

## 依賴關係

CalendarWeek 依賴以下檔案與元件：

1. CalendarWeek.ascx.cs：週控制項後端程式碼
2. System.Web.UI.WebControls：提供基本網頁控制項功能
3. System.Web.UI.HtmlControls：提供 HTML 控制項功能
4. System.Globalization：提供文化資訊和日期格式化功能
5. pagefunction.js：頁面通用 JavaScript 函數

## 使用者介面

CalendarWeek 的使用者介面由以下部分組成：

1. **標籤文字**：顯示「週」或自訂文字，提示使用者此控制項的用途
2. **輸入文字框**：允許使用者直接輸入週數值（範圍1-6，根據月份不同有所調整）
3. **下拉選單按鈕**：點擊後顯示可選的週數值清單
4. **下拉選單**：顯示當月可選的所有週數值，使用者可直接點選
5. **驗證提示**：當輸入無效週數時顯示錯誤提示

整體設計符合系統UI風格，提供清晰的視覺層次和直覺的操作方式。控制項在唯讀模式下僅顯示當前選擇的週數，不提供編輯功能。

## 控制項屬性

CalendarWeek 提供以下主要屬性：

1. **SelectedWeek**：
   - 類型：int
   - 功能：取得或設定選取的週次值（如「W01」）
   - 預設值：當前週次

2. **SelectedMonth**：
   - 類型：int
   - 功能：取得或設定選取的月份值（1-12）
   - 預設值：當前月份

3. **SelectedYear**：
   - 類型：int
   - 功能：取得或設定選取的年度值
   - 預設值：當前年度

4. **StartDate**：
   - 類型：DateTime
   - 功能：根據選取的年度、月份和週次，計算並返回該週的開始日期

5. **EndDate**：
   - 類型：DateTime
   - 功能：根據選取的年度、月份和週次，計算並返回該週的結束日期

6. **Enabled**：
   - 類型：bool
   - 功能：取得或設定控制項是否可用
   - 預設值：true

7. **Required**：
   - 類型：bool
   - 功能：取得或設定控制項是否為必填

8. **ReadOnly**：
   - 類型：bool
   - 功能：取得或設定控制項是否為唯讀

9. **LabelText**：
   - 類型：string
   - 功能：取得或設定控制項的標籤文字

10. **Width**：
    - 類型：Unit
    - 功能：取得或設定控制項的顯示寬度

11. **CssClass**：
    - 類型：string
    - 功能：取得或設定控制項的 CSS 類別

12. **IsValid**：
    - 類型：bool
    - 功能：取得控制項是否通過驗證（唯讀）

13. **WeekDefinition**：
    - 類型：WeekDefinitionType
    - 功能：設定週定義方式（按日曆週或商業週）

14. **MaxWeeksInMonth**：
    - 類型：int
    - 功能：取得目前月份的最大週數（唯讀）

## 控制項方法

控制項提供以下主要方法：

1. **BindYear**：
   - 功能：綁定年度下拉式選單的選項
   - 參數：預設選取年度值（可選）

2. **BindMonth**：
   - 功能：綁定月份下拉式選單的選項
   - 參數：預設選取月份值（可選）

3. **BindWeek**：
   - 功能：根據選取的年度和月份，綁定週次下拉式選單的選項
   - 參數：預設選取週次值（可選）

4. **GetWeeksInMonth**：
   - 功能：計算指定年度和月份中的週次資訊
   - 參數：年度、月份
   - 返回：週次資訊的集合

5. **SetSelectedValue**：
   - 功能：設定年度、月份和週次的選取值
   - 參數：年度、月份、週次

6. **UpdateWeeksForMonth**：
   - 功能：更新當前月份的可選週次

7. **GetWeekStartDate**：
   - 功能：取得所選週的開始日期
   - 返回：DateTime

8. **GetWeekEndDate**：
   - 功能：取得所選週的結束日期
   - 返回：DateTime

9. **Validate**：
   - 功能：驗證控制項的輸入值
   - 返回：bool

## 事件處理

控制項包含以下事件處理：

1. **WeekChanged**：
   - 觸發條件：使用者變更週次選擇時
   - 行為：更新開始日期和結束日期，觸發 WeekChanged 事件

2. **WeekValidated**：
   - 觸發條件：控制項驗證完成時
   - 行為：外部程式可以訂閱此事件，以便在控制項驗證完成時執行相應操作

## 使用範例

以下是 CalendarWeek 控制項的基本使用方式：

```html
<!-- 在 ASPX 頁面中引用控制項 -->
<uc:CalendarWeek ID="weekPicker" runat="server" OnWeekChanged="weekPicker_WeekChanged" />

<!-- 在程式碼中操作控制項 -->
<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            // 設定初始值
            weekPicker.SetSelectedValue(2025, 5, "W02");
        }
    }
    
    protected void weekPicker_WeekChanged(object sender, WeekChangedEventArgs e)
    {
        // 取得選取的值
        int year = weekPicker.SelectedYear;
        int month = weekPicker.SelectedMonth;
        string week = weekPicker.SelectedWeek;
        
        // 取得日期範圍
        DateTime startDate = weekPicker.StartDate;
        DateTime endDate = weekPicker.EndDate;
        
        // 執行其他操作...
    }
</script>
```

## 異常處理

控制項包含以下異常處理機制：

1. **輸入驗證**：
   - 檢查年度值是否在有效範圍內（通常為 1900-2099）
   - 檢查月份值是否在有效範圍內（1-12）
   - 檢查週次值是否符合格式要求（如「W01」）

2. **錯誤處理**：
   - 使用 try-catch 區塊處理可能發生的例外
   - 如日期計算錯誤、無效的日期格式等

3. **預設值處理**：
   - 當遇到無效值時，使用合理的預設值
   - 例如，無效年度使用當前年度，無效月份使用當前月份

## 效能考量

1. **下拉式選單綁定優化**：
   - 根據需要僅重新綁定必要的下拉式選單
   - 例如，變更年度時，月份選項不需要重新綁定

2. **日期計算優化**：
   - 使用 CultureInfo 和 Calendar 類別，以確保日期計算的準確性
   - 快取計算結果，避免重複計算

3. **用戶端處理**：
   - 使用 JavaScript 進行簡單的用戶端驗證和介面更新
   - 減少不必要的回傳，提高用戶體驗

## 安全性考量

1. **輸入驗證**：
   - 檢查所有輸入值的有效性，防止無效資料
   - 防止透過控制項的屬性傳入惡意資料

2. **資料繫結**：
   - 使用安全的資料繫結方式，避免資料注入風險

3. **權限控制**：
   - 控制項可以與系統的權限控制機制整合
   - 根據使用者權限來顯示或隱藏特定功能

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 年度選擇和切換功能正確性
   - 月份選擇和切換功能正確性
   - 週次選擇和切換功能正確性
   - 特殊情況處理（如月初月末週次）

2. **互動測試**：
   - 年度變更時月份和週次的更新行為
   - 月份變更時週次的更新行為
   - 控制項值變更事件的觸發

3. **界面測試**：
   - 控制項在各種瀏覽器下的渲染一致性
   - 控制項樣式與系統整體設計的協調性
   - 不同螢幕尺寸下的顯示效果

4. **整合測試**：
   - 與其他時間控制項的協同工作
   - 在各類報表頁面中的使用情境

## 待改進事項

1. 增加週次範圍選擇功能，允許選擇多個連續週次
2. 加入國際化支援，適應不同國家/地區的週次定義
3. 提供更豐富的外觀自訂選項，如顏色主題、字型大小等
4. 增加特殊週次顯示（如跨月週次的特殊標記）
5. 優化使用者體驗，如增加週次的視覺預覽
6. 支援更多的日期格式和日曆系統
7. 增加日期範圍的驗證和限制功能
8. 提供與行事曆整合的視覺化顯示

## 維護記錄

| 日期      | 版本   | 變更內容                       | 變更人員    |
|-----------|--------|--------------------------------|------------|
| 2025/5/13 | 1.0    | 首次建立週控制項規格書          | Claude AI  | 