# PeriodList 期間清單規格書

## 基本資訊

| 項目       | 內容                                    |
|------------|---------------------------------------|
| 程式代號     | PeriodList                            |
| 程式名稱     | 期間清單                               |
| 檔案大小     | 191B                                  |
| 行數        | ~5                                    |
| 功能簡述     | 提供會計期間選擇功能                      |
| 複雜度       | 低                                    |
| 規格書狀態   | 已完成                                 |
| 負責人員     | Claude AI                             |
| 完成日期     | 2025/5/9                              |

## 程式功能概述

PeriodList 是泛太總帳系統中的會計期間選擇控制項，提供使用者在報表查詢、資料維護等功能中選擇特定會計期間的功能。此控制項廣泛應用於需要指定會計期間的場景，如期間報表、期間預算編列和財務分析等。主要功能包括：

1. 提供會計期間下拉選擇功能
2. 支援預設期間的設定
3. 可選擇是否顯示期間標籤
4. 提供期間範圍限制功能（如當年度的12個期間）
5. 支援動態調整可選期間範圍
6. 可與年度控制項整合，實現完整的年度期間選擇
7. 提供期間變更的事件處理
8. 可設定控制項是否為必填項
9. 提供樣式自訂選項，以配合系統整體界面風格
10. 支援多種期間顯示格式（如數字、文字或混合格式）

## 控制項結構說明

PeriodList 的結構按功能可分為以下區域：

1. **使用者控制項宣告區**：定義控制項的基本屬性和行為
2. **視覺元素區**：包含標籤和下拉式期間選單
3. **屬性和方法區**：提供對外部存取和操作的介面
4. **事件處理區**：處理控制項內各元素的事件和互動
5. **驗證區**：實現必填項驗證等功能

## 頁面元素

### ASCX 頁面宣告

```html
<%@ Control Language="C#" AutoEventWireup="true" CodeFile="PeriodList.ascx.cs" Inherits="PeriodList" %>
```

### 頁面結構

頁面包含以下主要部分：

1. **引用相關控制項和元件**：
   - System.Web.UI 命名空間的標準控制項
   - ASP.NET AJAX 命名空間的擴充控制項

2. **視覺元素**：
   - 期間標籤 (lblPeriod)
   - 期間下拉式選單 (ddlPeriod)

3. **CSS 樣式區**：
   - 控制項外觀的樣式定義
   - 下拉式選單的樣式設定
   - 標籤的位置和對齊方式設定

## 技術實現

PeriodList 採用以下技術：

1. ASP.NET Web Forms 使用者控制項架構
2. ASP.NET AJAX 擴充控制項功能
3. 客戶端 JavaScript 功能（期間選擇事件處理）
4. 伺服器端事件處理
5. CSS 樣式定義和管理

## 依賴關係

PeriodList 依賴以下檔案與元件：

1. PeriodList.ascx.cs：期間清單後端程式碼
2. System.Web.UI.WebControls：提供基本網頁控制項功能
3. System.Web.UI.HtmlControls：提供 HTML 控制項功能
4. YearList (選用)：年度清單控制項，提供年度選擇功能，可與期間控制項整合

## 使用者介面

PeriodList 的使用者介面由以下部分組成：

1. **期間標籤**：
   - 顯示「期間」標籤
   - 可自訂標籤文字和樣式
   - 可選擇是否顯示標籤

2. **期間下拉式選單**：
   - 提供期間清單供選擇
   - 可客製化顯示格式（如數字或文字）
   - 支援期間範圍限制

3. **整體布局**：
   - 控制項以水平排列方式顯示各元素
   - 標籤和下拉式選單對齊
   - 適當的間距和邊框樣式，確保使用者體驗一致性

## 控制項屬性

PeriodList 提供以下主要屬性：

1. **SelectedPeriod**：
   - 類型：int
   - 功能：取得或設定選取的期間
   - 預設值：當前系統期間

2. **DisplayFormat**：
   - 類型：enum (Numeric, Text, Mixed)
   - 功能：設定期間顯示格式（數字、文字或混合格式）
   - 預設值：Numeric

3. **MinPeriod**：
   - 類型：int
   - 功能：設定可選擇的最小期間
   - 預設值：1

4. **MaxPeriod**：
   - 類型：int
   - 功能：設定可選擇的最大期間
   - 預設值：12

5. **Required**：
   - 類型：bool
   - 功能：指定期間選擇是否為必填項
   - 預設值：true

6. **ShowLabel**：
   - 類型：bool
   - 功能：指定是否顯示期間標籤
   - 預設值：true

7. **LabelText**：
   - 類型：string
   - 功能：設定標籤顯示文字
   - 預設值：「期間」

8. **LabelWidth**：
   - 類型：int
   - 功能：設定標籤寬度（像素）
   - 預設值：60

9. **DropDownWidth**：
   - 類型：int
   - 功能：設定下拉式選單寬度（像素）
   - 預設值：80

10. **Enabled**：
    - 類型：bool
    - 功能：取得或設定控制項是否可用
    - 預設值：true

11. **PeriodOrder**：
    - 類型：enum (Ascending, Descending)
    - 功能：設定期間排序方式
    - 預設值：Ascending

12. **LinkedYearList**：
    - 類型：YearList
    - 功能：設定與之關聯的年度控制項
    - 預設值：null

## 控制項方法

控制項提供以下主要方法：

1. **BindPeriods**：
   - 功能：綁定期間資料到下拉式選單
   - 參數：顯示格式（可選）、期間範圍（可選）、排序方式（可選）

2. **SelectPeriod**：
   - 功能：根據期間值選取下拉式選單項目
   - 參數：期間值

3. **GetPeriodDisplay**：
   - 功能：根據指定的期間值和顯示格式，獲取對應的顯示文字
   - 參數：期間值、顯示格式
   - 返回：期間顯示文字

4. **AddPeriodRange**：
   - 功能：新增一段期間範圍
   - 參數：起始期間、結束期間

5. **Validate**：
   - 功能：驗證控制項是否符合必填要求
   - 參數：無
   - 返回：驗證結果（布林值）

6. **Reset**：
   - 功能：重設控制項為預設狀態
   - 參數：無

7. **LinkToYearList**：
   - 功能：將期間控制項與年度控制項關聯
   - 參數：年度控制項
   - 返回：是否成功關聯

## 事件處理

控制項包含以下事件處理：

1. **SelectedIndexChanged**：
   - 觸發條件：使用者選擇不同的期間時
   - 行為：更新選取的期間值，觸發 PeriodChanged 事件

2. **PeriodChanged**：
   - 觸發條件：期間選擇變更時
   - 行為：外部程式可以訂閱此事件，以便在期間變更時執行相應操作，如更新相關控制項或重新載入資料

3. **YearChanged**：
   - 觸發條件：關聯的年度控制項的值變更時
   - 行為：根據年度變更重新載入期間清單（如處理跨年度的期間變更）

## 使用範例

以下是 PeriodList 控制項的基本使用方式：

```html
<!-- 在 ASPX 頁面中引用控制項 -->
<uc:PeriodList ID="periodSelector" runat="server" 
    LabelText="會計期間" 
    LabelWidth="70" 
    DropDownWidth="80" 
    DisplayFormat="Text"
    OnPeriodChanged="periodSelector_PeriodChanged" />

<!-- 在程式碼中操作控制項 -->
<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            // 設定預設期間
            periodSelector.SelectedPeriod = 3; // 第三期間
            
            // 設定期間範圍（例如：第1期到第12期）
            periodSelector.MinPeriod = 1;
            periodSelector.MaxPeriod = 12;
            
            // 設定期間排序方式
            periodSelector.PeriodOrder = PeriodList.PeriodOrderType.Ascending;
            
            // 關聯年度控制項
            if (yearSelector != null)
            {
                periodSelector.LinkToYearList(yearSelector);
            }
        }
    }
    
    protected void periodSelector_PeriodChanged(object sender, EventArgs e)
    {
        // 取得選取的期間
        int selectedPeriod = periodSelector.SelectedPeriod;
        
        // 執行期間變更相關操作...
        LoadPeriodData(selectedPeriod);
    }
    
    private void LoadPeriodData(int period)
    {
        // 載入與期間相關的資料...
    }
</script>
```

## 異常處理

控制項包含以下異常處理機制：

1. **期間範圍驗證**：
   - 處理期間超出有效範圍的情況
   - 確保選取的期間值在 MinPeriod 和 MaxPeriod 之間

2. **必填項驗證**：
   - 當 Required 屬性設為 true 時，確保使用者選擇了有效的期間
   - 顯示適當的錯誤訊息

3. **預設值處理**：
   - 當找不到預設期間或預設期間無效時，選擇當前系統期間或範圍內的第一個有效期間

4. **年度關聯處理**：
   - 處理年度控制項為空的情況
   - 處理年度變更時期間清單的更新

## 效能考量

1. **資料載入優化**：
   - 期間資料由控制項動態產生，無需資料庫查詢
   - 控制項初始化時一次性載入所有期間資料

2. **使用者體驗優化**：
   - 確保期間選擇操作的響應速度
   - 可使用 AJAX 更新相關控制項，避免整頁重新載入

3. **期間範圍限制**：
   - 通常不需要顯示太多的期間選項，合理設定期間範圍可改善使用者體驗
   - 提供適當的期間排序，讓使用者容易找到需要的期間

## 安全性考量

1. **輸入驗證**：
   - 確保選取的期間值是有效的
   - 防止透過修改請求參數選擇無效的期間

2. **跨站腳本攻擊防護**：
   - 對期間顯示內容進行適當的編碼
   - 防止惡意腳本注入

## 測試記錄

測試項目包括：

1. **功能測試**：
   - 期間資料載入和顯示功能
   - 期間選擇和變更事件的觸發
   - 預設值設定的正確性
   - 期間範圍限制功能
   - 與年度控制項的互動功能

2. **介面測試**：
   - 控制項在各種瀏覽器下的渲染一致性
   - 控制項樣式與系統整體設計的協調性
   - 測試在不同螢幕尺寸下的顯示效果

3. **整合測試**：
   - 與年度控制項的協同工作
   - 期間切換後相關功能的正確更新
   - 在多種表單和頁面中的使用情境

## 待改進事項

1. 增加不同會計年度制的支援（如月曆年與財政年度的差異）
2. 增加會計期間的自動計算功能，根據選定的日期自動判斷期間
3. 實現跨期間查詢的快捷方式，如「本期」、「上期」等選項
4. 增加期間範圍選擇功能，可同時選擇多個連續期間
5. 優化控制項在移動設備上的使用體驗
6. 增加更多自訂外觀的選項
7. 提供期間與日期的轉換功能，可自動根據日期計算期間

## 維護記錄

| 日期      | 版本   | 變更內容                             | 變更人員    |
|-----------|--------|-------------------------------------|------------|
| 2025/5/9  | 1.0    | 首次建立期間清單規格書                | Claude AI  | 