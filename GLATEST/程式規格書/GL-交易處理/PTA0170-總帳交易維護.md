# 程式規格書

## 1. 基本資訊

| 項目 | 說明 |
|-----|------|
| 程式代號 | PTA0170 |
| 程式名稱 | 總帳交易維護 |
| 版本號碼 | 1.0.0 |
| 所屬模組 | 總帳模組 |
| 檔案位置 | GLATEST/GL/PTA0170.aspx, GLATEST/GL/PTA0170.aspx.cs |
| 程式類型 | 交易處理 |
| 建立日期 | [初次建立日期] |
| 建立人員 | [初次建立人員] |
| 最後修改日期 | [最後修改日期] |
| 最後修改人員 | [最後修改人員] |

## 2. 功能概述

### 2.1 主要功能

總帳交易維護程式提供使用者對傳票基本資料進行新增、修改、刪除和查詢等維護操作。使用者可輸入傳票各項資訊，包括傳票編號、日期、科目、部門、金額、摘要等資料，並可進行傳票審核及列印等功能。

### 2.2 業務流程

本程式在總帳業務流程中扮演資料輸入和維護的核心角色：
1. 會計人員建立傳票資料
2. 主管審核傳票資料
3. 傳票過帳進入總帳
4. 產生會計報表

### 2.3 使用頻率

- 使用頻率：高
- 使用時機：每日交易資料輸入、月底結帳作業

### 2.4 使用者角色

- 會計人員：建立和維護傳票資料
- 部門主管：審核傳票
- 財務主管：最終審核及核准

## 3. 系統架構

### 3.1 技術架構

- 前端：ASP.NET Web Form、JavaScript、AJAX
- 後端：C#、ADO.NET
- 資料庫：SQL Server

### 3.2 資料表使用

| 資料表名稱 | 用途 | 存取方式 |
|-----------|------|---------|
| GL_TRANS_H | 傳票表頭資料 | 讀取/新增/修改/刪除 |
| GL_TRANS_D | 傳票明細資料 | 讀取/新增/修改/刪除 |
| GL_ACCOUNT | 會計科目資料 | 讀取 |
| GL_DEPT | 部門資料 | 讀取 |
| SYS_USER | 使用者資料 | 讀取 |
| SYS_FLOW | 簽核流程資料 | 讀取/新增/修改 |

### 3.3 相依元件

| 元件名稱 | 用途 | 說明 |
|---------|------|------|
| Page_BaseClass | 頁面基底類別 | 提供基本頁面功能和認證 |
| GLA0110TManager | 交易管理 | 處理交易數據的存取和業務邏輯 |
| Subjects | 科目控制項 | 提供科目選擇功能 |
| YearList | 年度清單 | 提供年度選擇功能 |
| PeriodList | 期間清單 | 提供會計期間選擇 |

## 4. 畫面規格

### 4.1 畫面布局

```
+---------------------------------------------------+
|               總帳交易維護                         |
+---------------------------------------------------+
| 年度: [下拉選單]  期間: [下拉選單]                  |
| 傳票編號: [輸入框] 傳票日期: [日期選擇]              |
| 傳票摘要: [輸入框]                                 |
+---------------------------------------------------+
| 明細資料:                                          |
|  科目代號   科目名稱    部門   借方金額   貸方金額   |
| [輸入框] [自動顯示] [下拉] [輸入框]   [輸入框]      |
| [輸入框] [自動顯示] [下拉] [輸入框]   [輸入框]      |
| [輸入框] [自動顯示] [下拉] [輸入框]   [輸入框]      |
|                                                   |
| 合計:                    [總借方]   [總貸方]        |
+---------------------------------------------------+
| [新增] [修改] [刪除] [查詢] [審核] [列印] [關閉]    |
+---------------------------------------------------+
```

### 4.2 欄位說明

| 欄位名稱 | 資料型態 | 長度 | 必填 | 驗證規則 | 預設值 | 說明 |
|---------|---------|------|------|---------|-------|------|
| 年度 | 整數 | 4 | Y | 有效年度 | 當前年度 | 會計年度 |
| 期間 | 整數 | 2 | Y | 1-12 | 當前月份 | 會計期間 |
| 傳票編號 | 字串 | 10 | Y | 不可重複 | 自動產生 | 傳票唯一編號 |
| 傳票日期 | 日期 | - | Y | 有效日期 | 當前日期 | 傳票日期 |
| 傳票摘要 | 字串 | 100 | N | - | - | 傳票整體摘要 |
| 科目代號 | 字串 | 10 | Y | 須為有效科目 | - | 會計科目代號 |
| 部門 | 字串 | 10 | N | 須為有效部門 | - | 部門代號 |
| 借方金額 | 數值 | 12,2 | 條件性 | >=0 | 0 | 借方金額，借貸必填其一 |
| 貸方金額 | 數值 | 12,2 | 條件性 | >=0 | 0 | 貸方金額，借貸必填其一 |

### 4.3 按鈕功能

| 按鈕名稱 | 功能描述 | 處理邏輯 |
|---------|---------|---------|
| 新增 | 新增傳票資料 | 清空畫面並設定為新增模式 |
| 修改 | 修改傳票資料 | 儲存目前編輯的傳票資料 |
| 刪除 | 刪除傳票資料 | 刪除目前顯示的傳票資料 |
| 查詢 | 查詢傳票資料 | 開啟查詢視窗供使用者查詢傳票 |
| 審核 | 傳票審核 | 提交傳票進入審核流程 |
| 列印 | 列印傳票 | 列印目前顯示的傳票資料 |
| 關閉 | 關閉視窗 | 關閉目前視窗並返回上一頁 |

### 4.4 畫面流程

1. 使用者開啟程式，系統預設為新增模式
2. 使用者輸入傳票資料後點擊新增，儲存後清空畫面
3. 使用者可透過查詢按鈕開啟查詢視窗尋找傳票
4. 修改/刪除必須先查詢出傳票再操作
5. 審核與列印同樣需要先查詢傳票
6. 使用者可隨時關閉視窗返回上一頁

## 5. 處理邏輯

### 5.1 主要流程

```
開始
 ↓
檢查使用者權限
 ↓
讀取基礎資料 (年度、期間、科目等)
 ↓
顯示主畫面
 ↓
用戶選擇操作 → 查詢傳票資料 → 顯示查詢結果
 ↓                                ↓
輸入傳票資料                       修改傳票資料
 ↓                                ↓
驗證輸入資料 → 資料不正確 → 顯示錯誤訊息
 ↓                           ↑
儲存資料 → 儲存失敗 → 顯示錯誤訊息
 ↓
結束
```

### 5.2 資料驗證規則

1. 傳票表頭資料驗證：
   - 傳票編號不可重複
   - 傳票日期必須為有效日期且在會計期間內
   - 借貸方總金額必須相等

2. 傳票明細資料驗證：
   - 科目代號必須存在於會計科目檔
   - 每行明細借貸方至少填寫一項
   - 同一行不得同時有借貸方金額
   - 金額必須大於零

### 5.3 計算邏輯

1. 傳票編號自動產生規則：
   - 格式：YYMMNNNNNN (年月+六位流水號)
   - 每月自動重新編號

2. 借貸方總額計算：
   - 借方總額 = 所有明細之借方金額加總
   - 貸方總額 = 所有明細之貸方金額加總
   - 檢查機制：借方總額需等於貸方總額

### 5.4 例外處理

1. 資料庫連線錯誤：
   - 顯示錯誤訊息並記錄錯誤日誌
   - 提供重試選項

2. 同時編輯衝突：
   - 使用樂觀鎖定機制(Optimistic Locking)
   - 衝突時顯示警告訊息並提供重新整理選項

3. 會計期間已關閉：
   - 檢查傳票日期是否在已關閉的會計期間
   - 若是，則顯示警告訊息並禁止儲存

## 6. SQL查詢

### 6.1 主要查詢

```sql
-- 查詢傳票表頭
SELECT 
    TH.TransNo, TH.TransDate, TH.Summary, 
    TH.CreateUser, TH.CreateDate, TH.ModifyUser, 
    TH.ModifyDate, TH.Status
FROM 
    GL_TRANS_H TH
WHERE 
    TH.Year = @Year 
    AND TH.Period = @Period
    AND TH.TransNo = @TransNo
```

### 6.2 資料新增

```sql
-- 新增傳票表頭
INSERT INTO GL_TRANS_H (
    TransNo, Year, Period, TransDate, 
    Summary, CreateUser, CreateDate, Status
) VALUES (
    @TransNo, @Year, @Period, @TransDate, 
    @Summary, @CreateUser, GETDATE(), 'N'
)

-- 新增傳票明細
INSERT INTO GL_TRANS_D (
    TransNo, LineNo, AcctNo, DeptNo, 
    DrAmt, CrAmt, Desc
) VALUES (
    @TransNo, @LineNo, @AcctNo, @DeptNo, 
    @DrAmt, @CrAmt, @Desc
)
```

### 6.3 資料更新

```sql
-- 更新傳票表頭
UPDATE GL_TRANS_H
SET 
    TransDate = @TransDate,
    Summary = @Summary,
    ModifyUser = @ModifyUser,
    ModifyDate = GETDATE()
WHERE 
    TransNo = @TransNo
    AND Year = @Year
    AND Period = @Period
```

### 6.4 資料刪除

```sql
-- 刪除傳票明細
DELETE FROM GL_TRANS_D
WHERE TransNo = @TransNo

-- 刪除傳票表頭
DELETE FROM GL_TRANS_H
WHERE TransNo = @TransNo
    AND Year = @Year
    AND Period = @Period
    AND Status = 'N'
```

## 7. 程式碼說明

### 7.1 重要方法

| 方法名稱 | 功能描述 | 參數說明 | 返回值 |
|---------|---------|---------|-------|
| LoadTransData | 載入傳票資料 | transNo: 傳票編號 | bool: 載入成功與否 |
| SaveTransData | 儲存傳票資料 | mode: 新增/修改模式 | bool: 儲存成功與否 |
| DeleteTransData | 刪除傳票資料 | transNo: 傳票編號 | bool: 刪除成功與否 |
| ValidateTransData | 驗證傳票資料 | - | bool: 驗證通過與否 |
| CalculateTotal | 計算借貸方總額 | - | void |

### 7.2 關鍵程式碼

```csharp
// 傳票資料驗證
private bool ValidateTransData()
{
    // 驗證表頭資料
    if (string.IsNullOrEmpty(txtTransNo.Text))
    {
        ShowMessage("傳票編號不可為空");
        return false;
    }
    
    // 驗證傳票日期
    if (!IsValidDate(txtTransDate.Text))
    {
        ShowMessage("傳票日期格式不正確");
        return false;
    }
    
    // 驗證明細資料
    if (grdDetail.Rows.Count == 0)
    {
        ShowMessage("傳票必須包含至少一筆明細");
        return false;
    }
    
    // 驗證借貸方平衡
    decimal drTotal = 0, crTotal = 0;
    foreach (GridViewRow row in grdDetail.Rows)
    {
        drTotal += Convert.ToDecimal(((TextBox)row.FindControl("txtDrAmt")).Text);
        crTotal += Convert.ToDecimal(((TextBox)row.FindControl("txtCrAmt")).Text);
    }
    
    if (drTotal != crTotal)
    {
        ShowMessage("借貸方金額不平衡");
        return false;
    }
    
    return true;
}
```

### 7.3 事件處理

| 事件名稱 | 觸發條件 | 處理邏輯 |
|---------|---------|---------|
| Page_Load | 頁面載入時 | 初始化頁面設定、載入基礎資料 |
| btnSave_Click | 點擊儲存按鈕 | 驗證輸入資料並儲存傳票 |
| btnQuery_Click | 點擊查詢按鈕 | 開啟查詢視窗 |
| btnDelete_Click | 點擊刪除按鈕 | 刪除當前傳票 |
| grdDetail_RowDataBound | 資料繫結至表格時 | 設定明細表格樣式和計算 |

## 8. 報表輸出

### 8.1 報表格式

傳票列印格式包含表頭和明細資料，主要欄位包括：
- 表頭：傳票編號、傳票日期、會計年度、會計期間、摘要
- 明細：序號、科目代號、科目名稱、部門、借方金額、貸方金額、明細摘要
- 表尾：總計金額、製表人、審核人

### 8.2 Excel匯出格式

Excel匯出格式與畫面顯示一致，包含：
- 工作表1：傳票基本資料
- 工作表2：傳票明細資料
- 所有金額欄位設定為數值格式(#,##0.00)
- 日期欄位設定為日期格式(yyyy/MM/dd)

### 8.3 資料列印

提供多種列印選項：
- 單張傳票列印
- 批次傳票列印
- 支援PDF輸出
- 支援直接列印至預設印表機

## 9. 相關檔案

### 9.1 原始程式檔案

| 檔案名稱 | 檔案類型 | 檔案大小 | 檔案行數 | 說明 |
|---------|---------|---------|---------|------|
| PTA0170.aspx | ASPX | 8.9KB | 141 | 傳票維護頁面 |
| PTA0170.aspx.cs | C# | 14KB | 390 | 傳票維護程式碼 |
| PTA0170.aspx.designer.cs | C# | ~2KB | ~50 | 設計器產生的程式碼 |

### 9.2 相依元件檔案

| 檔案名稱 | 檔案類型 | 說明 |
|---------|---------|------|
| GLA0110TManager.cs | C# | 交易管理元件 |
| Page_BaseClass.cs | C# | 頁面基底類別 |
| Subjects.ascx | ASCX | 科目控制項 |
| YearList.ascx | ASCX | 年度控制項 |
| PeriodList.ascx | ASCX | 期間控制項 |

## 10. 修改歷史

| 版本號 | 修改日期 | 修改人員 | 修改內容 | 備註 |
|-------|---------|---------|---------|------|
| 1.0.0 | [日期] | [人員] | 初版建立 | 初次建立程式規格書 |

## 11. 備註與注意事項

### 11.1 已知問題

1. 大量明細資料時，畫面反應速度較慢
2. 特殊會計科目輸入時可能需要額外驗證

### 11.2 未來改進計劃

1. 優化查詢效能，加入快速查詢功能
2. 增加批次傳票匯入功能
3. 整合電子發票資料自動建立傳票

### 11.3 操作注意事項

1. 已審核的傳票不允許修改或刪除
2. 會計期間關閉後，該期間的傳票資料不允許新增或修改
3. 每日作業結束前應確認所有傳票借貸方是否平衡

### 11.4 特殊案例說明

1. 結帳傳票處理：年度結帳時系統會自動產生特殊傳票，這類傳票有專屬的處理邏輯
2. 沖銷傳票處理：沖銷傳票會自動生成相反分錄，需注意原傳票與沖銷傳票的關聯 